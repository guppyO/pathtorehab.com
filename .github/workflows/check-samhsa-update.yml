name: Check SAMHSA Data Update

on:
  # Run weekly on Sunday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Also allow manual trigger
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  check-for-update:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      latest_count: ${{ steps.check.outputs.latest_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for SAMHSA update
        id: check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Run the check script - exit code 1 means update available
          set +e
          npx tsx scripts/check-samhsa-update.ts
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 1 ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

  update-data:
    runs-on: ubuntu-latest
    needs: check-for-update
    if: needs.check-for-update.outputs.has_update == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download latest SAMHSA data
        run: npx tsx scripts/download-data.ts

      - name: Ingest data to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: npx tsx scripts/ingest-data.ts

      - name: Fix facility counts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: npx tsx scripts/fix-counts.ts

      - name: Notify success
        run: |
          echo "âœ… Successfully updated SAMHSA data"
          echo "ðŸš€ Data will be live on next deployment"

  notify-no-update:
    runs-on: ubuntu-latest
    needs: check-for-update
    if: needs.check-for-update.outputs.has_update == 'false'

    steps:
      - name: Log status
        run: |
          echo "âœ“ No SAMHSA data update available"
          echo "Current data is up to date"
